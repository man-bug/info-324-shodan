import React from "react";
import { CveResult } from "@/app/actions/fetch-cve-data";
import { Badge } from "@/components/ui/badge";
import Link from "next/link";
import { cn } from "@/lib/utils";
import { getLastTwoSentences } from "./_utils";

export function CveItem({ cve, index }: { cve: CveResult; index: number }): JSX.Element {
    return (
        <li className="text-sm my-4 first-of-type:mt-0">
            <div className="relative w-full flex items-center pb-4">
                <div className="grow h-px bg-border" />
                <span className="px-2 font-bold uppercase rounded-full bg-muted/50 border aspect-square grid items-center">
                    {index + 1}
                </span>
                <div className="grow h-px bg-border" />
            </div>
            <div className="flex flex-col space-y-2">
                <p className="font-bold">
                    <span>
                        {cve.id}
                        {cve.references.map((reference, idx) => (
                            <Link
                                key={reference.url + idx}
                                href={reference.url}
                                target="_blank"
                                className="text-[10px] ml-0.5 text-accent-blue align-super"
                            >
                                [{idx + 1}]
                            </Link>
                        ))}
                    </span>
                </p>
                <p className="text-muted-foreground">{getLastTwoSentences(cve.description)}</p>
                {[
                    { label: "Severity", value: cve.severity },
                    { label: "Tags", value: cve.tags.length > 1 ? cve.tags.join(", ") : "NULL" },
                ].map((item) => (
                    <div className="flex justify-between items-end" key={item.label}>
                        <p className="font-bold text-foreground leading-none">{item.label}</p>
                        <div className="flex-grow border-b-2 border-dotted mx-0.5"></div>
                        <p
                            className={cn(
                                "text-muted-foreground leading-none",
                                item.value === "CRITICAL" && "text-destructive font-bold"
                            )}
                        >
                            {item.value}
                        </p>
                    </div>
                ))}
                <div className="flex flex-col shrink-0">
                    {[
                        { label: "Confidentiality", value: cve.confidentialityImpact },
                        { label: "Integrity", value: cve.integrityImpact },
                        { label: "Availability", value: cve.availabilityImpact },
                    ].map((impact) => (
                        <div
                            key={impact.label}
                            className="flex items-center justify-between gap-2 py-1"
                        >
                            <span className="text-[13px] text-muted-foreground">
                                {impact.label}
                            </span>
                            <Badge
                                className={cn(
                                    "w-fit !bg-muted/50 border",
                                    impact.value === "HIGH"
                                        ? "!text-destructive"
                                        : "!text-foreground"
                                )}
                            >
                                {impact.value}
                            </Badge>
                        </div>
                    ))}
                </div>
            </div>
        </li>
    );
}
